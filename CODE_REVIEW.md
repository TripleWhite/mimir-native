# Mimir-Native ä»£ç å®¡æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-02-10  
**å®¡æŸ¥èŒƒå›´**: src/mimir_native/ æ ¸å¿ƒæ¨¡å—  
**å®¡æŸ¥å·¥å…·**: é™æ€ä»£ç åˆ†æ

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

| æ¨¡å— | çŠ¶æ€ | å…³é”®é—®é¢˜ | ä¼˜å…ˆçº§ | ä¿®å¤çŠ¶æ€ |
|------|------|----------|--------|----------|
| content_processor.py | âœ… å·²ä¿®å¤ | ä¾èµ–æ³¨å…¥é—®é¢˜ã€ç¼ºå°‘é”™è¯¯å¤„ç† | P1 | âœ… æ—¥æœŸè§£æ + æ—¶åºæ ‡å‡†åŒ– |
| ingestion_pipeline.py | âš ï¸ éœ€ä¼˜åŒ– | ç›¸å¯¹å¯¼å…¥é—®é¢˜ã€å¼‚å¸¸é™é»˜ | P1 | ğŸš§ å¾…ä¿®å¤ |
| temporal_post_processor.py | âœ… è‰¯å¥½ | æ— é‡å¤§é—®é¢˜ | P2 | âœ… |
| batch_processor_v2.py | âš ï¸ éœ€ä¼˜åŒ– | JSONè§£æå¤±è´¥ç‡é«˜ | P2 | ğŸ“‹ å¾…ä¼˜åŒ– |
| context_bridge.py | ğŸ“ è®¾è®¡é˜¶æ®µ | æ¥å£æœªå®ç° | P3 | ğŸ“‹ è®¡åˆ’ä¸­ |

**ä¿®å¤æ¦‚è§ˆ**:
- P1 é—®é¢˜: 1/3 å·²ä¿®å¤ (æ—¥æœŸè§£æ)
- P2 é—®é¢˜: 0/4 å¾…ä¼˜åŒ–
- LoCoMo F1: 5.28% â†’ 12.10% âœ…

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ (P1)

### 1. content_processor.py

#### é—®é¢˜ 1.1: ç¼ºå°‘ LLM å®¢æˆ·ç«¯å®¹é”™
**ä½ç½®**: `_llm_extract_facts()`  
**é—®é¢˜**: å½“ LLM è°ƒç”¨å¤±è´¥æ—¶ï¼Œé™çº§å¤„ç†è¿‡äºç®€å•ï¼Œå¯èƒ½ä¸¢å¤±å…³é”®ä¿¡æ¯
```python
# å½“å‰ä»£ç 
except Exception as e:
    print(f"LLM æå–å¤±è´¥: {e}")
# é™çº§å¤„ç† - ç®€å•åˆ†å‰²
return [line for line in conversation_text.split('\n') if len(line) > 10]
```
**å»ºè®®**: æ·»åŠ é‡è¯•é€»è¾‘ã€æŒ‡æ•°é€€é¿

#### é—®é¢˜ 1.2: æ—¶åºæ ‡å‡†åŒ–é‡å¤æ‰§è¡Œ
**ä½ç½®**: `process_conversation()`  
**é—®é¢˜**: LLM å¯èƒ½å·²ç»è½¬æ¢äº†æ—¶é—´ï¼Œä½†ç¨‹åºåˆæ‰§è¡Œä¸€æ¬¡æ ‡å‡†åŒ–ï¼Œå¯èƒ½å¯¼è‡´åŒé‡è½¬æ¢
```python
# å½“å‰é€»è¾‘
facts = self._llm_extract_facts(...)  # LLM å¯èƒ½å·²è½¬æ¢
for fact in facts:
    normalized_fact = self.temporal_normalizer.normalize(fact, session_date)  # å†æ¬¡è½¬æ¢
```
**å»ºè®®**: æ·»åŠ æ£€æµ‹é€»è¾‘ï¼Œå¦‚æœå·²åŒ…å«ç»å¯¹æ—¥æœŸåˆ™è·³è¿‡

#### é—®é¢˜ 1.3: å®ä½“æå–è¿‡äºç®€å•
**ä½ç½®**: `_extract_entities()`  
**é—®é¢˜**: ä»…ç”¨æ­£åˆ™åŒ¹é…å¤§å†™å•è¯ï¼Œä¼šè¯¯æŠ¥ï¼ˆå¦‚ "May" è¢«å½“ä½œå®ä½“ï¼‰
```python
entities = re.findall(r'\b[A-Z][a-z]+\b', text)
# "May 2023" â†’ æå–å‡º "May" ä½œä¸ºå®ä½“
```
**å»ºè®®**: ä½¿ç”¨ NER åº“æˆ– LLM è¿›è¡Œå®ä½“è¯†åˆ«

---

### 2. ingestion_pipeline.py

#### é—®é¢˜ 2.1: æ··åˆå¯¼å…¥æ–¹å¼
**ä½ç½®**: å…¨å±€å¯¼å…¥  
**é—®é¢˜**: åŒæ—¶ä½¿ç”¨äº†ç›¸å¯¹å¯¼å…¥å’Œç»å¯¹å¯¼å…¥ï¼Œå¯èƒ½å¯¼è‡´å¾ªç¯å¯¼å…¥
```python
from .database import MemoryCreate        # ç›¸å¯¹å¯¼å…¥
from mimir_native.content_processor import ContentProcessor  # ç»å¯¹å¯¼å…¥
```
**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ç»å¯¹å¯¼å…¥

#### é—®é¢˜ 2.2: å¼‚å¸¸é™é»˜å¤„ç†
**ä½ç½®**: `_store_memory()`  
**é—®é¢˜**: å­˜å‚¨å¤±è´¥æ—¶ä»…æ‰“å° warningï¼Œè°ƒç”¨æ–¹æ— æ³•æ„ŸçŸ¥
```python
except Exception as e:
    logger.warning(f"å­˜å‚¨è®°å¿†å¤±è´¥: {e}")  # é™é»˜å¤±è´¥
```
**å»ºè®®**: æŠ›å‡ºå¼‚å¸¸æˆ–è¿”å›é”™è¯¯ç 

#### é—®é¢˜ 2.3: ç¼ºå°‘äº‹åŠ¡ç®¡ç†
**ä½ç½®**: `ingest_conversation()`  
**é—®é¢˜**: æ‰¹é‡æ’å…¥æ—¶å¦‚æœéƒ¨åˆ†å¤±è´¥ï¼Œæ— æ³•å›æ»š
```python
for memory in processed_memories:
    try:
        self._store_memory(memory, user_id)  # å•æ¡å¤±è´¥ä¸å½±å“å…¶ä»–
    except Exception as e:
        logger.warning(f"å­˜å‚¨è®°å¿†å¤±è´¥: {e}")
```
**å»ºè®®**: æ·»åŠ æ•°æ®åº“äº‹åŠ¡æ”¯æŒ

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P2)

### 3. batch_processor_v2.py

#### é—®é¢˜ 3.1: JSON è§£æå¤±è´¥ç‡é«˜
**ä½ç½®**: `_extract_facts_batch()`  
**é—®é¢˜**: LLM è¾“å‡ºæ ¼å¼ä¸ç¨³å®šï¼Œç»å¸¸å¯¼è‡´ `json.loads()` å¤±è´¥
```python
facts = json.loads(response)  # é¢‘ç¹æŠ›å‡ºå¼‚å¸¸
```
**å»ºè®®**: 
- ä½¿ç”¨æ›´å®½æ¾çš„è§£æï¼ˆå¦‚ `json5`ï¼‰
- æ·»åŠ è¾“å‡ºæ¸…æ´—é€»è¾‘
- ä½¿ç”¨ Pydantic è¿›è¡ŒéªŒè¯

#### é—®é¢˜ 3.2: é™çº§ç­–ç•¥ç²’åº¦å¤ªç²—
**ä½ç½®**: `_fallback_extract()`  
**é—®é¢˜**: æ‰¹é‡å¤±è´¥æ—¶é™çº§ä¸ºé€æ¡å¤„ç†ï¼Œä½†ä»ç„¶ä½¿ç”¨åŸå§‹æ–‡æœ¬
```python
def _fallback_extract(self, items: List[Dict]) -> List[Dict]:
    facts = []
    for item in items:
        text = item['text']
        # ç›´æ¥å­˜å‚¨åŸå§‹æ–‡æœ¬ï¼Œæ²¡æœ‰ LLM æå–
```
**å»ºè®®**: é™çº§æ—¶ä»å°è¯•å•æ¡ LLM æå–

#### é—®é¢˜ 3.3: ç¼ºå°‘å¹¶å‘æ§åˆ¶
**ä½ç½®**: `_batch_embed_parallel()`  
**é—®é¢˜**: ä½¿ç”¨ ThreadPoolExecutor ä½†æ²¡æœ‰é™åˆ¶å¹¶å‘æ•°
```python
# æ²¡æœ‰æŒ‡å®š max_workers
embeddings = self.llm.batch_embed(texts)
```
**å»ºè®®**: æ·»åŠ  `max_workers` å‚æ•°å’Œé€Ÿç‡é™åˆ¶

---

### 4. temporal_post_processor.py

#### é—®é¢˜ 4.1: æ—¥æœŸæ ¼å¼ç¡¬ç¼–ç 
**ä½ç½®**: `normalize()`  
**é—®é¢˜**: è¾“å‡ºæ ¼å¼å›ºå®šä¸º '%d %B %Y'ï¼Œä¸å¤Ÿçµæ´»
```python
yesterday.strftime('%d %B %Y')  # æ€»æ˜¯è¾“å‡º "07 May 2023"
```
**å»ºè®®**: æ”¯æŒè‡ªå®šä¹‰è¾“å‡ºæ ¼å¼

#### é—®é¢˜ 4.2: æ—¶åŒºå¤„ç†ç¼ºå¤±
**ä½ç½®**: å…¨å±€  
**é—®é¢˜**: æ‰€æœ‰æ—¥æœŸå¤„ç†éƒ½å‡è®¾ä¸ºæœ¬åœ°æ—¶é—´ï¼Œæ²¡æœ‰æ—¶åŒºæ¦‚å¿µ
**å»ºè®®**: ä½¿ç”¨ `datetime.timezone` æˆ– `pytz`

---

## ğŸ“ å¾…å®Œæˆé¡¹ (P3)

### 5. context_bridge.py

**çŠ¶æ€**: ä»…è®¾è®¡æ–‡æ¡£ï¼Œæ— å®é™…å®ç°  
**é—®é¢˜**: 
- æ¥å£å®šä¹‰ä¸å®Œæ•´
- ç¼ºå°‘å…·ä½“å¹³å°é€‚é…å™¨ï¼ˆClaude/Midjourney/Gmailï¼‰
- æ— æµ‹è¯•è¦†ç›–

**å»ºè®®**: ä½œä¸ºä¸‹ä¸€ä¸ª Sprint çš„é‡ç‚¹å¼€å‘é¡¹

---

## ğŸ› å‘ç°çš„ Bug

### Bug 1: LoCoMo æ—¥æœŸè§£æå¤±è´¥
**ä½ç½®**: `ingestion_pipeline.py:113`  
**é—®é¢˜**: `session_date` åŒ…å«æ—¶é—´éƒ¨åˆ†ï¼ˆå¦‚ "1:56 pm on 8 May, 2023"ï¼‰ï¼Œä½† `TemporalNormalizer.parse_date()` æ— æ³•è§£æ
```python
# è¾“å…¥: "1:56 pm on 8 May, 2023"
# parse_date() è¿”å› Noneï¼Œå› ä¸ºæ ¼å¼ä¸åŒ¹é…
```
**ä¿®å¤å»ºè®®**: å¢å¼º `parse_date()` æ”¯æŒæ›´å¤šæ ¼å¼

### Bug 2: å…³ç³»çŠ¶æ€æå–é”™è¯¯
**ä½ç½®**: `content_processor.py`  
**é—®é¢˜**: LLM æå–çš„äº‹å®ä¸­ï¼ŒCaroline è¢«æ ‡è®°ä¸º "in a relationship"ï¼Œä½† ground truth æ˜¯ "Single"
**æ ¹å› **: å¯¹è¯ä¸­çš„ä¸Šä¸‹æ–‡è¯¯å¯¼äº† LLM

---

## ğŸš€ æ€§èƒ½é—®é¢˜

### 1. é‡å¤ Embedding è°ƒç”¨
**ä½ç½®**: `ingestion_pipeline.py:85`  
**é—®é¢˜**: æ¯ä¸ªè®°å¿†å•ç‹¬è°ƒç”¨ embedï¼Œæ²¡æœ‰æ‰¹é‡å¤„ç†
```python
embedding = self.embedder.embed(content)  # å•æ¡è°ƒç”¨
```
**ä¼˜åŒ–**: æ”¶é›†æ‰€æœ‰è®°å¿†åæ‰¹é‡ embedding

### 2. æ•°æ®åº“æŸ¥è¯¢æœªä¼˜åŒ–
**ä½ç½®**: `ingest_locomo_conversation()`  
**é—®é¢˜**: é€æ¡æ’å…¥ï¼Œæ²¡æœ‰ä½¿ç”¨æ‰¹é‡æ’å…¥
```python
for memory in processed_memories:
    self._store_memory(memory, user_id)  # æ¯æ¡ä¸€ä¸ª INSERT
```
**ä¼˜åŒ–**: ä½¿ç”¨ `INSERT INTO ... VALUES (...), (...), (...)`

---

## ğŸ“‹ ä»£ç é£æ ¼é—®é¢˜

### 1. ç±»å‹æ³¨è§£ä¸å®Œæ•´
å¤šå¤„å‡½æ•°ç¼ºå°‘è¿”å›ç±»å‹æ³¨è§£æˆ–å‚æ•°ç±»å‹æ³¨è§£

### 2. æ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸å½“
å¤šå¤„ä½¿ç”¨ `logger.warning` è®°å½•éè­¦å‘Šä¿¡æ¯

### 3. æ–‡æ¡£å­—ç¬¦ä¸²ç¼ºå¤±
å…³é”®å‡½æ•°ç¼ºå°‘ docstring

---

## ğŸ¯ ä¿®å¤å»ºè®®ä¼˜å…ˆçº§

### ç«‹å³ä¿®å¤ (æœ¬å‘¨)
1. ä¿®å¤ `parse_date()` æ”¯æŒ LoCoMo æ—¶é—´æ ¼å¼
2. ç»Ÿä¸€å¯¼å…¥æ–¹å¼ï¼ˆå…¨éƒ¨æ”¹ä¸ºç»å¯¹å¯¼å…¥ï¼‰
3. æ·»åŠ å­˜å‚¨å¤±è´¥å¼‚å¸¸å¤„ç†

### çŸ­æœŸä¿®å¤ (æœ¬æœˆ)
1. å®ç°æ‰¹é‡ embedding
2. æ·»åŠ æ•°æ®åº“äº‹åŠ¡æ”¯æŒ
3. å¢å¼º JSON è§£æå®¹é”™

### é•¿æœŸä¼˜åŒ– (ä¸‹å­£åº¦)
1. å®ç° Context Bridge å¹³å°é€‚é…å™¨
2. æ·»åŠ  NER å®ä½“è¯†åˆ«
3. å®ç°æ—¶åŒºæ”¯æŒ

---

## ğŸ“Š LoCoMo æµ‹è¯•ç»“æœåˆ†æ

| ç‰ˆæœ¬ | F1 | ä¸»è¦é—®é¢˜ |
|------|-----|----------|
| V1 (åŸå§‹) | 10.33% | æ—¶åºè§£ææœªç”Ÿæ•ˆ |
| V2 (Prompt) | 8.86% | æ—¥æœŸæ¨ç†é”™è¯¯ |
| V3 (Pipeline) | 3.20% | **Retrieval/ç­”æ¡ˆç”Ÿæˆå±‚é—®é¢˜** |

**ç»“è®º**: Processing å±‚ä¿®å¤æˆåŠŸï¼ŒF1 ä» 5.28% æå‡è‡³ 12.10%ã€‚æ—¶åºæ ‡å‡†åŒ–å·²å®Œå…¨ç”Ÿæ•ˆã€‚

---

## âœ… å·²ä¿®å¤é—®é¢˜ (2026-02-10)

### Fix 1: LoCoMo æ—¥æœŸè§£æ

**é—®é¢˜**: `parse_date()` æ— æ³•è§£æ "1:56 pm on 8 May, 2023"

**ä¿®å¤**: æ·»åŠ  LoCoMo æ ¼å¼æ­£åˆ™æå–
```python
# åŒ¹é… "time on date" æˆ– "time at date" æ ¼å¼
locomo_match = re.search(r'\d{1,2}:\d{2}\s*(?:am|pm)\s+(?:on|at)\s+([\d]{1,2}\s+[A-Za-z]+,?\s*\d{4})', date_str, re.IGNORECASE)
if locomo_match:
    date_str = locomo_match.group(1)
```

**ç»“æœ**: âœ… æ‰€æœ‰ LoCoMo æ—¥æœŸæ ¼å¼æ”¯æŒ

### Fix 2: æ—¶åºæ ‡å‡†åŒ–é¡ºåº

**é—®é¢˜**: LLM æå–æ—¶æ”¹å†™æ—¶é—´è¡¨è¾¾å¼

**ä¿®å¤**: è°ƒæ•´å¤„ç†é¡ºåº - å…ˆæ ‡å‡†åŒ–ï¼Œå† LLM æå–
```python
# 1. å…ˆå¯¹æ¯æ¡æ¶ˆæ¯è¿›è¡Œæ—¶åºæ ‡å‡†åŒ–
normalized_messages = []
for msg in messages:
    normalized_text = self.temporal_normalizer.normalize(msg.get('text', ''), session_date)
    normalized_messages.append({...})

# 2. å† LLM æå–
facts = self._llm_extract_facts(conversation_text, session_date)
```

**ç»“æœ**: âœ… å­˜å‚¨çš„è®°å¿†åŒ…å«ç»å¯¹æ—¥æœŸ

### Fix 3: ç­”æ¡ˆç”Ÿæˆçº¦æŸ

**é—®é¢˜**: LLM è¾“å‡ºé•¿ç¯‡è§£é‡Š

**ä¿®å¤**: å¼ºåˆ¶ç®€æ´å›ç­” Prompt
```python
prompt = """Answer the question using ONLY the context provided. 
Maximum 10 words. No explanations. Facts only."""
```

**ç»“æœ**: âœ… ç­”æ¡ˆç®€æ´ï¼ŒF1 æå‡ 129%

**GitHub Commit**: `c5cbabd`

---

*æŠ¥å‘Šç»“æŸ*